<!DOCTYPE html>
<html>
<head>
    <title>Test RÃ¨gles Firestore - ServiceItems</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 10px; padding: 15px; font-size: 16px; cursor: pointer; }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .info { background: #2196F3; color: white; }
        #results { margin-top: 20px; padding: 15px; border: 1px solid #ccc; min-height: 200px; }
        .log { margin: 5px 0; padding: 5px; border-left: 3px solid #ccc; }
        .log.success { border-left-color: #4CAF50; background: #f1f8e9; }
        .log.error { border-left-color: #f44336; background: #ffebee; }
        .log.info { border-left-color: #2196F3; background: #e3f2fd; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Test RÃ¨gles Firestore - ServiceItems</h1>
    
    <p><strong>Instructions :</strong></p>
    <ol>
        <li>Cliquez sur "Tester Auth" pour vÃ©rifier votre connexion</li>
        <li>Cliquez sur "Tester Lecture" pour voir si vous pouvez lire les serviceItems</li>
        <li>Cliquez sur "Tester Ã‰criture" pour voir si vous pouvez ajouter un serviceItem</li>
    </ol>
    
    <button onclick="testAuth()" class="info">1. Tester Auth</button>
    <button onclick="testRead()" class="info">2. Tester Lecture</button>
    <button onclick="testWrite()" class="info">3. Tester Ã‰criture</button>
    <button onclick="clearResults()" style="background: #ff9800; color: white;">ğŸ—‘ï¸ Effacer</button>
    
    <div id="results"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            orderBy 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Configuration Firebase (remplacez par vos vraies valeurs)
        const firebaseConfig = {
            apiKey: "AIzaSyAv8N8QKY5LcQPwGp4AhD3pF9fDhPXoN2Y",
            authDomain: "gouvernement-532ba.firebaseapp.com",
            projectId: "gouvernement-532ba",
            storageBucket: "gouvernement-532ba.firebasestorage.app",
            messagingSenderId: "542842494848",
            appId: "1:542842494848:web:66e7e85e2b9b20b9d4e61d"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Exposer les fonctions globalement
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.orderBy = orderBy;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;

        console.log('ğŸ”¥ Firebase initialisÃ©');
        
        // Surveiller l'Ã©tat d'authentification
        onAuthStateChanged(auth, (user) => {
            if (user) {
                log(`âœ… Utilisateur connectÃ©: ${user.email} (UID: ${user.uid})`, 'success');
            } else {
                log(`âŒ Aucun utilisateur connectÃ©`, 'error');
            }
        });
    </script>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testAuth() {
            log('ğŸ” Test d\'authentification...', 'info');
            
            try {
                const user = window.auth.currentUser;
                if (user) {
                    log(`âœ… Utilisateur connectÃ©: ${user.email}`, 'success');
                    log(`ğŸ“‹ UID: ${user.uid}`, 'info');
                    log(`ğŸ“§ Email vÃ©rifiÃ©: ${user.emailVerified}`, 'info');
                    
                    // Tester l'accÃ¨s au document utilisateur
                    log('ğŸ” Test d\'accÃ¨s au document utilisateur...', 'info');
                    const userDoc = await window.db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        log(`âœ… Document utilisateur trouvÃ©`, 'success');
                        log(`ğŸ“‹ RÃ´le: ${userData.role || 'non dÃ©fini'}`, 'info');
                        log(`ğŸ“‹ Permissions: ${JSON.stringify(userData.permissions || [])}`, 'info');
                    } else {
                        log(`âŒ Document utilisateur inexistant dans Firestore!`, 'error');
                        log(`âš ï¸ CrÃ©ez un document dans users/${user.uid} avec role: "admin"`, 'error');
                    }
                    
                } else {
                    log(`âŒ Aucun utilisateur connectÃ©`, 'error');
                    log(`ğŸ’¡ Connectez-vous d'abord sur votre app`, 'info');
                }
                
            } catch (error) {
                log(`âŒ Erreur auth: ${error.message}`, 'error');
                console.error('Erreur auth:', error);
            }
        }

        async function testRead() {
            log('ğŸ“– Test de lecture des serviceItems...', 'info');
            
            try {
                const q = window.query(
                    window.collection(window.db, 'serviceItems'), 
                    window.orderBy('category'), 
                    window.orderBy('name')
                );
                
                const querySnapshot = await window.getDocs(q);
                
                log(`âœ… Lecture rÃ©ussie! ${querySnapshot.docs.length} services trouvÃ©s`, 'success');
                
                querySnapshot.docs.forEach((doc, index) => {
                    const data = doc.data();
                    log(`ğŸ“„ Service ${index + 1}: ${data.name} (${data.category}) - $${data.price}`, 'info');
                });
                
                if (querySnapshot.docs.length === 0) {
                    log(`â„¹ï¸ Aucun service dans la base de donnÃ©es`, 'info');
                }
                
            } catch (error) {
                log(`âŒ Erreur lecture: ${error.code} - ${error.message}`, 'error');
                if (error.code === 'permission-denied') {
                    log(`ğŸ”’ PROBLÃˆME DE PERMISSIONS: VÃ©rifiez les rÃ¨gles Firestore!`, 'error');
                }
                console.error('Erreur lecture:', error);
            }
        }

        async function testWrite() {
            log('âœï¸ Test d\'Ã©criture d\'un serviceItem...', 'info');
            
            try {
                const testService = {
                    name: `Test Service ${Date.now()}`,
                    category: 'vente',
                    price: 99.99,
                    description: 'Service de test pour vÃ©rifier les rÃ¨gles',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                log(`ğŸ“ Tentative d'ajout: ${testService.name}`, 'info');
                
                const docRef = await window.addDoc(
                    window.collection(window.db, 'serviceItems'), 
                    testService
                );
                
                log(`âœ… Ã‰CRITURE RÃ‰USSIE! ID: ${docRef.id}`, 'success');
                log(`ğŸ‰ Les rÃ¨gles Firestore permettent l'ajout de services!`, 'success');
                
                // Re-tester la lecture pour voir le nouveau service
                setTimeout(() => {
                    log(`ğŸ”„ Re-test de lecture pour voir le nouveau service...`, 'info');
                    testRead();
                }, 1000);
                
            } catch (error) {
                log(`âŒ ERREUR Ã‰CRITURE: ${error.code} - ${error.message}`, 'error');
                
                if (error.code === 'permission-denied') {
                    log(`ğŸ”’ PROBLÃˆME CRITIQUE: Les rÃ¨gles Firestore bloquent l'Ã©criture!`, 'error');
                    log(`ğŸ“‹ Solutions possibles:`, 'error');
                    log(`   1. DÃ©ployez les nouvelles rÃ¨gles Firestore`, 'error');
                    log(`   2. VÃ©rifiez que votre utilisateur a le rÃ´le "admin" ou "manager"`, 'error');
                    log(`   3. VÃ©rifiez que votre utilisateur a la permission "accounting"`, 'error');
                } else if (error.code === 'unauthenticated') {
                    log(`ğŸ” ERREUR AUTH: Connectez-vous d'abord!`, 'error');
                }
                
                console.error('Erreur Ã©criture:', error);
            }
        }

        // Log initial
        log('ğŸš€ Test des rÃ¨gles Firestore initialisÃ©', 'info');
        log('ğŸ‘† Cliquez sur les boutons ci-dessus pour tester', 'info');
    </script>
</body>
</html> 