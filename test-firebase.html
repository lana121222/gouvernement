<!DOCTYPE html>
<html>
<head>
    <title>Test Firebase - Gouvernement RP</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 10px; padding: 10px; }
        #results { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Test Firebase - Gouvernement RP</h1>
    
    <h2>Tests d'authentification</h2>
    <button onclick="testAuth()">Test Auth Status</button>
    <button onclick="testLogin()">Test Login Admin</button>
    <button onclick="testLogout()">Test Logout</button>
    
    <h2>Tests des services</h2>
    <button onclick="testAddService()">Test Ajouter Service</button>
    <button onclick="testListServices()">Test Lister Services</button>
    <button onclick="testPermissions()">Test Permissions</button>
    
    <div id="results"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

        // Configuration Firebase (vous devez mettre votre vraie config ici)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        }

        const app = initializeApp(firebaseConfig)
        const db = getFirestore(app)
        const auth = getAuth(app)

        function addResult(message, type = 'info') {
            const results = document.getElementById('results')
            const p = document.createElement('p')
            p.className = type
            p.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`
            results.appendChild(p)
            console.log(`[TEST] ${message}`)
        }

        window.testAuth = function() {
            addResult('ğŸ” Test du statut d\'authentification...', 'info')
            const user = auth.currentUser
            if (user) {
                addResult(`âœ… Utilisateur connectÃ©: ${user.email} (UID: ${user.uid})`, 'success')
            } else {
                addResult('âŒ Aucun utilisateur connectÃ©', 'error')
            }
        }

        window.testLogin = async function() {
            try {
                addResult('ğŸ”‘ Tentative de connexion admin...', 'info')
                const result = await signInWithEmailAndPassword(auth, 'admin@gouvernement-rp.com', 'admin123')
                addResult(`âœ… Connexion rÃ©ussie: ${result.user.email}`, 'success')
            } catch (error) {
                addResult(`âŒ Erreur de connexion: ${error.message} (Code: ${error.code})`, 'error')
            }
        }

        window.testLogout = async function() {
            try {
                addResult('ğŸšª DÃ©connexion...', 'info')
                await signOut(auth)
                addResult('âœ… DÃ©connexion rÃ©ussie', 'success')
            } catch (error) {
                addResult(`âŒ Erreur de dÃ©connexion: ${error.message}`, 'error')
            }
        }

        window.testAddService = async function() {
            try {
                addResult('ğŸ“ Test d\'ajout de service...', 'info')
                
                if (!auth.currentUser) {
                    addResult('âŒ Vous devez Ãªtre connectÃ© pour ajouter un service', 'error')
                    return
                }
                
                addResult(`ğŸ” Utilisateur: ${auth.currentUser.email}`, 'info')
                
                const docRef = await addDoc(collection(db, 'serviceItems'), {
                    name: 'Test Service ' + Date.now(),
                    category: 'vente',
                    price: 10.50,
                    description: 'Service de test automatique',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                })
                addResult(`âœ… Service ajoutÃ© avec succÃ¨s! ID: ${docRef.id}`, 'success')
            } catch (error) {
                addResult(`âŒ Erreur lors de l'ajout: ${error.message} (Code: ${error.code})`, 'error')
                if (error.code === 'permission-denied') {
                    addResult('ğŸš¨ Erreur de permissions! VÃ©rifiez les rÃ¨gles Firestore et le rÃ´le utilisateur.', 'error')
                }
            }
        }

        window.testListServices = async function() {
            try {
                addResult('ğŸ“‹ Test de listage des services...', 'info')
                const querySnapshot = await getDocs(collection(db, 'serviceItems'))
                addResult(`âœ… ${querySnapshot.size} service(s) trouvÃ©(s)`, 'success')
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data()
                    addResult(`  ğŸ“Œ ${data.name} - ${data.price}$ (${data.category})`, 'info')
                })
            } catch (error) {
                addResult(`âŒ Erreur lors du listage: ${error.message} (Code: ${error.code})`, 'error')
            }
        }

        window.testPermissions = async function() {
            try {
                addResult('ğŸ›¡ï¸ Test des permissions utilisateur...', 'info')
                
                if (!auth.currentUser) {
                    addResult('âŒ Aucun utilisateur connectÃ©', 'error')
                    return
                }

                // Essayer de lire le document utilisateur
                const userDocRef = doc(db, 'users', auth.currentUser.uid)
                const userDoc = await getDoc(userDocRef)
                
                if (userDoc.exists()) {
                    const userData = userDoc.data()
                    addResult(`âœ… Document utilisateur trouvÃ©:`, 'success')
                    addResult(`  ğŸ‘¤ Email: ${userData.email}`, 'info')
                    addResult(`  ğŸ­ RÃ´le: ${userData.role}`, 'info')
                    addResult(`  ğŸ”‘ Permissions: ${userData.permissions.join(', ')}`, 'info')
                    
                    if (userData.role === 'admin' || userData.role === 'manager' || userData.permissions.includes('accounting')) {
                        addResult(`âœ… L'utilisateur a les permissions pour la comptabilitÃ©`, 'success')
                    } else {
                        addResult(`âŒ L'utilisateur n'a PAS les permissions pour la comptabilitÃ©`, 'error')
                    }
                } else {
                    addResult(`âŒ Aucun document utilisateur trouvÃ© pour l'UID: ${auth.currentUser.uid}`, 'error')
                    addResult(`â„¹ï¸ Cela peut expliquer les erreurs de permissions`, 'info')
                }
                
            } catch (error) {
                addResult(`âŒ Erreur lors du test de permissions: ${error.message} (Code: ${error.code})`, 'error')
            }
        }

        // Ã‰couter les changements d'authentification
        onAuthStateChanged(auth, (user) => {
            if (user) {
                addResult(`ğŸ”„ Changement d'authentification: connectÃ© en tant que ${user.email}`, 'info')
            } else {
                addResult(`ğŸ”„ Changement d'authentification: dÃ©connectÃ©`, 'info')
            }
        })

        // Message de dÃ©marrage
        addResult('ğŸš€ Page de test chargÃ©e. Cliquez sur les boutons pour tester les fonctionnalitÃ©s.', 'info')
    </script>
</body>
</html> 