rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ” FONCTION HELPER: VÃ©rifier si l'utilisateur est authentifiÃ©
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // ğŸ” FONCTION HELPER: Obtenir les donnÃ©es utilisateur
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // ğŸ” FONCTION HELPER: VÃ©rifier le rÃ´le admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().role == 'admin';
    }
    
    // ğŸ” FONCTION HELPER: VÃ©rifier le rÃ´le manager ou admin
    function isManagerOrAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().role in ['admin', 'manager'];
    }
    
    // ğŸ” FONCTION HELPER: VÃ©rifier les permissions accounting
    function hasAccountingPermission() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (getUserData().role in ['admin', 'manager'] ||
              'accounting' in getUserData().get('permissions', []));
    }
    
    // ğŸ‘¤ USERS COLLECTION - Gestion des utilisateurs
    match /users/{userId} {
      // Lecture: utilisateur peut lire ses propres infos OU admin peut lire tous les utilisateurs
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // Ã‰criture: permissions admin requises (sauf crÃ©ation)
      allow write: if isAdmin();
      
      // ğŸ†• CRÃ‰ATION: permettre la crÃ©ation lors de l'inscription
      allow create: if request.auth != null && request.auth.uid == userId;
    }
    
    // ğŸ“ PROFILES COLLECTION - Profils utilisateurs Ã©tendus
    match /profiles/{profileId} {
      // Lecture: utilisateur peut lire son propre profil OU admin peut lire tous les profils
      allow read: if isAuthenticated() && (request.auth.uid == profileId || isAdmin());
      
      // Ã‰criture: utilisateur peut crÃ©er/modifier son propre profil
      allow write: if isAuthenticated() && request.auth.uid == profileId;
      
      // ğŸ†• CRÃ‰ATION: permettre la crÃ©ation lors de l'inscription
      allow create: if request.auth != null && request.auth.uid == profileId;
    }
    
    // ğŸ’¼ EMPLOYEES COLLECTION - Gestion des employÃ©s
    match /employees/{employeeId} {
      // Lecture: tous les utilisateurs authentifiÃ©s (pour voir la liste)
      allow read: if isAuthenticated();
      
      // Ã‰criture: seulement admin et manager
      allow write: if isManagerOrAdmin();
    }
    
    // ğŸ’° TRANSACTIONS COLLECTION - Transactions financiÃ¨res
    match /transactions/{transactionId} {
      // Lecture et Ã©criture: permissions accounting requises
      allow read, write: if hasAccountingPermission();
    }
    
    // ğŸ› ï¸ SERVICE ITEMS COLLECTION - Catalogue des services et prix
    match /serviceItems/{serviceItemId} {
      // Lecture: tous les utilisateurs authentifiÃ©s (pour voir les prix)
      allow read: if isAuthenticated();
      
      // Ã‰criture: permissions accounting requises
      allow write: if hasAccountingPermission();
    }
    
    // ğŸ“Š SERVICE TRANSACTIONS COLLECTION - Historique des services
    match /serviceTransactions/{serviceTransactionId} {
      // Lecture: tous les utilisateurs authentifiÃ©s (pour voir l'historique)
      allow read: if isAuthenticated();
      
      // Ã‰criture: permissions accounting requises
      allow write: if hasAccountingPermission();
    }
    
    // ğŸ¯ BONUS CONFIGS COLLECTION - Configurations de primes par grade
    match /bonus_configs/{bonusConfigId} {
      // Lecture: tous les utilisateurs authentifiÃ©s (pour calculs de primes)
      allow read: if isAuthenticated();
      
      // Ã‰criture: permissions accounting requises (gestion des primes)
      allow write: if hasAccountingPermission();
    }
    
    // ğŸ—„ï¸ ACCOUNTING BACKUPS COLLECTION - Sauvegardes comptabilitÃ©
    match /accounting_backups/{backupId} {
      // Seuls les admins peuvent gÃ©rer les sauvegardes
      allow read, write: if isAdmin();
    }
    
    // ğŸ“‹ REPORTS COLLECTION - Rapports et statistiques
    match /reports/{reportId} {
      // Lecture: permissions accounting
      allow read: if hasAccountingPermission();
      
      // Ã‰criture: admin seulement
      allow write: if isAdmin();
    }
    
    // ğŸ”§ SETTINGS COLLECTION - Configuration de l'application
    match /settings/{settingId} {
      // Lecture: tous les utilisateurs authentifiÃ©s
      allow read: if isAuthenticated();
      
      // Ã‰criture: admin seulement
      allow write: if isAdmin();
    }
    
    // ğŸ“ LOGS COLLECTION - Logs d'activitÃ©
    match /logs/{logId} {
      // Lecture: admin seulement
      allow read: if isAdmin();
      
      // Ã‰criture: tous les utilisateurs authentifiÃ©s (pour crÃ©er des logs)
      allow create: if isAuthenticated();
      
      // Pas de modification ou suppression des logs
      allow update, delete: if false;
    }
    
    // ğŸ”’ RÃˆGLE PAR DÃ‰FAUT: Tout le reste est interdit
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 